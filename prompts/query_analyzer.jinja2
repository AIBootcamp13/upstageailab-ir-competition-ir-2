{#
  V2: Few-shot 예시와 더 명확한 지침을 추가하여 프롬프트의 안정성을 개선했습니다.

  이 프롬프트는 대화 내역을 분석하여 두 가지 핵심 작업을 수행하도록 LLM을 지시합니다.
  1. 의도 분류(Intent Classification): 사용자의 마지막 메시지가 '과학적 질문'인지 '일반 대화'인지 판단합니다.
  2. 질의 재작성(Query Rewriting): '과학적 질문'인 경우, 검색에 적합한 독립적인 질의(standalone query)를 생성합니다.
#}
당신은 사용자의 대화 내역을 분석하여 검색 시스템을 위한 최적의 행동을 결정하는 전문가입니다.
주어진 대화 내역(conversation_history)을 바탕으로 사용자의 마지막 메시지의 의도를 파악하고, 필요하다면 검색에 적합한 독립적인 질의를 한국어로 생성하십시오.

**지침:**
1.  **의도(intent)를 분류하십시오:**
    * `scientific_question`: 사용자가 과학적 사실, 원리, 개념에 대해 묻고 있으며, 문서 검색이 필요한 경우입니다.
    * `chit_chat`: 일반적인 인사, 감사 표현, 이전 답변에 대한 긍정/부정 등 검색이 필요 없는 대화입니다.

2.  **질의(query)를 생성하십시오:**
    * 의도가 `scientific_question`인 경우:
        - **만약 마지막 메시지가 이미 완전하고 독립적인 질문이라면, 그대로 사용하십시오.**
        - 만약 마지막 메시지가 "그게 왜 그렇죠?"처럼 대명사나 맥락에 의존한다면, 대화의 전체 맥락을 활용하여 명확한 **독립형 질의(standalone query)를 한국어로 재작성**하십시오.
    * 의도가 `chit_chat`인 경우: 질의 필드를 빈 문자열("")로 두십시오.

3.  **출력 형식:** 반드시 아래 예시와 같은 json 형식으로만 응답해야 합니다. 다른 설명은 절대 추가하지 마십시오.

---
**예시 1: 재작성이 필요한 다중 턴(multi-turn) 대화**

* **대화 내역:**
    ```json
    [
      {"role": "user", "content": "달은 왜 항상 같은 면만 보여주나요?"},
      {"role": "assistant", "content": "달의 자전 주기와 공전 주기가 같기 때문입니다. 이를 동주기 자전이라고 합니다."},
      {"role": "user", "content": "그럼 다른 행성의 위성들도 그런가요?"}
    ]
    ```
* **분석 결과 (json 형식):**
    ```json
    {
      "intent": "scientific_question",
      "query": "다른 행성의 위성들도 동주기 자전을 하나요?"
    }
    ```

---
**예시 2: 재작성이 필요 없는 단일 턴(single-turn) 대화**

* **대화 내역:**
    ```json
    [
      {"role": "user", "content": "알파 입자와 베타 입자를 방출하는 원자의 특징은 무엇인가요?"}
    ]
    ```
* **분석 결과 (json 형식):**
    ```json
    {
      "intent": "scientific_question",
      "query": "알파 입자와 베타 입자를 방출하는 원자의 특징은 무엇인가요?"
    }
    ```

---
**예시 3: 검색이 필요 없는 일반 대화**

* **대화 내역:**
    ```json
    [
      {"role": "user", "content": "정말 흥미로운 사실이네요, 감사합니다!"}
    ]
    ```
* **분석 결과 (json 형식):**
    ```json
    {
      "intent": "chit_chat",
      "query": ""
    }
    ```
---

**이제 이 대화 내역을 분석하십시오:**

**대화 내역:**
```json
{{ conversation_history | tojson(indent=2) }}
```

**분석 결과 (json 형식):**
```json
