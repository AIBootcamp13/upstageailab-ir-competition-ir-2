# Prompt for Designing Query Enhancement Logic in RAG Systems

You are an AI assistant tasked with designing and refining query enhancement logic for a modular Retrieval-Augmented Generation (RAG) system focused on scientific document question-answering. This system uses components like retrieval (BM25 + dense vector search with Redis caching), generation (OpenAI/Ollama implementations), and orchestration (pipeline coordination with query rewriting and tool calling). Your goal is to analyze the provided examples of query enhancement techniques (e.g., rewriting, step-back prompting, decomposition, HyDE, multi-query retrieval) and use them to propose or improve logic that enhances retrieval accuracy for scientific queries.

Key guidelines:
- Consider how these techniques address common issues like vague queries, context dependency, or mismatched keywords in scientific documents.
- Propose implementations that integrate with the project's architecture, such as modifying retrieval tools or orchestration pipelines.
- Output should include: (1) A brief explanation of the enhanced logic, (2) Pseudocode or code snippets for integration (e.g., in Python for modules like `src/ir_core/retrieval/` or `src/ir_core/orchestration/`), and (3) Examples of how it improves retrieval for the given documents.
- Ensure suggestions align with performance priorities (e.g., vectorized operations, parallel processing) and avoid pitfalls like mismatched embedding dimensions.

Below are concrete examples of query enhancement techniques applied to sample scientific documents. Use these to inform your designs.

Consider the following 2 rows of Scientific Document for IR.

1. Document 1:
```json
{"docid": "42508ee0-c543-4338-878e-d98c6babee66", "src": "ko_mmlu__nutrition__test", "content": "건강한 사람이 에너지 균형을 평형 상태로 유지하는 것은 중요합니다. 에너지 균형은 에너지 섭취와 에너지 소비의 수학적 동등성을 의미합니다. 일반적으로 건강한 사람은 1-2주의 기간 동안 에너지 균형을 달성합니다. 이 기간 동안에는 올바른 식단과 적절한 운동을 통해 에너지 섭취와 에너지 소비를 조절해야 합니다. 식단은 영양가 있는 식품을 포함하고, 적절한 칼로리를 섭취해야 합니다. 또한, 운동은 에너지 소비를 촉진시키고 근육을 강화시킵니다. 이렇게 에너지 균형을 유지하면 건강을 유지하고 비만이나 영양 실조와 같은 문제를 예방할 수 있습니다. 따라서 건강한 사람은 에너지 균형을 평형 상태로 유지하는 것이 중요하며, 이를 위해 1-2주의 기간 동안 식단과 운동을 조절해야 합니다."}
```

2. Document 2:
```json
{"docid": "910107a6-2a42-41a2-b337-fbf22d6440fe", "src": "ko_ai2_arc__ARC_Challenge__test", "content": "마이애미파랑나비는 남부 플로리다에서 멸종 위기에 처한 종입니다. 이 나비의 개체수 감소를 초래했을 가능성이 가장 높은 요인은 주택 건설 증가입니다. 남부 플로리다 지역에서는 최근 몇 년간 주택 건설이 급증하였고, 이로 인해 서식지가 감소하고 개체들의 서식 환경이 파괴되었습니다. 마이애미파랑나비는 특정한 식물에 의존하여 번식하고 생존하는데, 주택 건설로 인해 이 식물들의 서식지가 감소하였기 때문에 개체수가 감소한 것으로 추정됩니다. 이러한 주택 건설 증가는 마이애미파랑나비뿐만 아니라 다른 생물종들에게도 영향을 미치고 있으며, 생태계의 균형을 위해 적절한 조치가 필요합니다. 주택 건설 증가를 제한하거나 대안적인 서식지를 마련하는 등의 방안이 고려되어야 합니다."}
```

### **기준 문서**

* **문서 1 (`...ee66`)**: 건강한 사람의 에너지 균형 (섭취 vs 소비) 유지 방법에 대한 내용. 키워드: `에너지 균형`, `식단`, `운동`, `1-2주`.
* **문서 2 (`...40fe`)**: 마이애미파랑나비의 멸종 위기 원인으로 주택 건설로 인한 서식지 파괴를 지목하는 내용. 키워드: `마이애미파랑나비`, `멸종 위기`, `주택 건설`, `서식지 감소`.

---

### **쿼리 향상 기법별 적용 예시**

#### 1. 질의 재작성 (Query Rewriting)

**문제점**: 사용자의 질문이 대화의 일부이거나 너무 간결하여 그 자체만으로는 검색이 어려운 경우.

**시나리오**: 사용자와 챗봇이 다이어트에 대해 대화하고 있습니다.

* **사용자**: "살 빼는 법 좀 알려줘."
* **챗봇**: "건강한 체중 감량을 위해서는 식단 조절과 운동을 통해 에너지 섭취와 소비의 균형을 맞추는 것이 중요합니다."
* **사용자**: "그럼 구체적으로 어떻게 해야 하는데?"

이 마지막 질문은 이전 대화의 맥락 없이는 의미가 없습니다.

* **향상 전 (검색 실패)**:
    * **원본 검색어**: `그럼 구체적으로 어떻게 해야 하는데?`
    * **문제**: 이 검색어에는 '에너지', '식단', '운동'과 같은 핵심 키워드가 전혀 없어 **문서 1**을 찾지 못합니다.

* **향상 후 (검색 성공)**:
    * **LLM의 역할**: 이전 대화의 맥락(`건강한 체중 감량`, `에너지 균형`)과 마지막 질문을 결합하여 하나의 완전한 독립형 질문을 생성합니다.
    * **재작성된 검색어**: `건강한 체중 감량을 위해 에너지 균형을 맞추는 구체적인 식단과 운동 방법은 무엇인가?`
    * **결과**: 이 재작성된 쿼리는 `에너지 균형`, `식단`, `운동` 키워드를 포함하므로 **문서 1 (`...ee66`)**을 성공적으로 검색합니다.

#### 2. 스텝백 프롬프트 (Step-Back Prompting)

**문제점**: 사용자의 질문이 너무 구체적이거나 전문적이어서, 관련된 일반적인 내용을 담고 있는 문서를 놓칠 수 있는 경우.

**시나리오**: 사용자가 매우 구체적인 생태학적 질문을 합니다.

* **향상 전 (검색 실패 가능성)**:
    * **원본 검색어**: `플로리다에서 주택 건설이 마이애미파랑나비의 숙주 식물(host plant)에 미치는 영향은?`
    * **문제**: **문서 2**는 '숙주 식물'이라는 구체적인 단어 대신 '서식지 감소'라는 더 넓은 개념을 사용합니다. 키워드 기반 검색이나 단순 벡터 검색은 이 문서를 놓칠 수 있습니다.

* **향상 후 (검색 성공)**:
    * **LLM의 역할**: 너무 구체적인 질문에서 한 걸음 물러나, 근본적인 원리를 묻는 상위 질문을 생성합니다.
    * **스텝백 검색어**: `인간의 도시 개발이 특정 나비 종의 멸종 위기에 미치는 요인은 무엇인가?`
    * **결과**: 이 더 넓은 범위의 스텝백 쿼리는 `도시 개발(주택 건설)`, `나비 종(마이애미파랑나비)`, `멸종 위기`와 같은 개념을 포괄하므로 **문서 2 (`...40fe`)**를 안정적으로 찾아냅니다. 시스템은 이 문서를 먼저 찾은 뒤, 그 내용을 바탕으로 사용자의 원래 구체적인 질문에 답변할 수 있습니다.

#### 3. 질의 분해 (Query Decomposition)

**문제점**: 하나의 질문 안에 여러 개의 독립적인 질문이 포함된 복합 질문.

**시나리오**: 사용자가 에너지 균형에 대해 여러 가지를 동시에 묻습니다.

* **향상 전 (불완전한 검색)**:
    * **원본 검색어**: `에너지 균형이란 무엇이고, 그걸 유지하기 위한 활동과 기간은 어떻게 돼?`
    * **문제**: 이 긴 질문을 통째로 검색하면, 시스템은 일부 키워드(예: '에너지 균형')에만 집중하고 다른 부분('기간')에 대한 내용은 놓칠 수 있습니다.

* **향상 후 (포괄적인 검색)**:
    * **LLM의 역할**: 복합 질문을 여러 개의 단순하고 명확한 하위 질문으로 분해합니다.
    * **분해된 검색어**:
        1.  `에너지 균형의 정의`
        2.  `에너지 균형 유지를 위한 신체 활동`
        3.  `에너지 균형을 달성하는 데 필요한 기간`
    * **결과**: 분해된 각 검색어는 **문서 1 (`...ee66`)**의 특정 부분과 강력하게 연결됩니다. (1. `에너지 섭취와 소비의 동등성`, 2. `운동`, 3. `1-2주`). 시스템은 이 모든 하위 질문에 대한 정보를 종합하여 완전한 답변을 생성할 수 있습니다.

#### 4. HyDE (가상 문서 임베딩)

**문제점**: 사용자의 질문이 개념적이고 추상적이어서, 문서의 구체적인 표현과 키워드가 거의 일치하지 않는 경우.

**시나리오**: 사용자가 환경 파괴에 대해 일반적인 질문을 합니다.

* **향상 전 (검색 실패)**:
    * **원본 검색어**: `인간의 욕심이 자연에 미치는 영향`
    * **문제**: 이 검색어의 키워드(`욕심`, `자연`)는 **문서 2**의 키워드(`주택 건설`, `서식지 파괴`)와 전혀 일치하지 않습니다.

* **향상 후 (검색 성공)**:
    * **LLM의 역할 (HyDE)**: 이 질문에 대한 이상적인 **가상 답변**을 먼저 생성합니다.
    * **생성된 가상 문서**: *"인간의 경제 발전 욕구는 종종 무분별한 개발로 이어집니다. 예를 들어, 도시 확장을 위한 대규모 주택 건설은 특정 동식물의 서식지를 파괴하여 해당 종을 멸종 위기로 내몰기도 합니다."*
    * **검색 방식**: 원본 질문 대신, 이 풍부한 내용의 **가상 문서에 대한 벡터 임베딩**을 사용하여 검색을 수행합니다.
    * **결과**: 이 가상 문서의 의미는 **문서 2 (`...40fe`)**의 내용과 의미적으로 매우 유사합니다. 따라서 벡터 검색을 통해 키워드가 전혀 다름에도 불구하고 정확한 문서를 찾아낼 수 있습니다.
물론입니다. 앞서 설명한 기법들에 더해, 검색 정확도를 높일 수 있는 또 다른 강력한 고급 기법을 구체적인 예시와 함께 설명해 드리겠습니다.

### 5\. 다중 질의 검색 (Multi-Query Retrieval)

**문제점**: 사용자의 질문이 너무 광범위하거나 일반적이어서, 검색 결과가 너무 많아 가장 적절한 문서를 찾기 어려운 경우.

**개념**: 이 기법은 LLM을 사용하여 사용자의 원본 질문을 **여러 개의 다른 관점**을 가진 다양한 버전의 질문으로 생성하는 것입니다. 하나의 잠재적으로 불완전한 쿼리에 의존하는 대신, 시스템은 생성된 모든 변형 쿼리에 대해 검색을 실행한 다음 그 결과를 종합합니다. 이는 재현율(Recall)을 높이는 매우 효과적인 방법입니다.

**시나리오**: 사용자가 인간 활동이 야생 동물에 미치는 영향에 대해 광범위한 질문을 합니다.

  * **향상 전 (보통의 결과)**:

      * **원본 검색어**: `인간 활동이 야생 동물에 미치는 영향은 무엇인가요?`
      * **문제**: 이 질문은 괜찮지만 매우 일반적입니다. \*\*문서 2 (`...40fe`)\*\*를 찾을 수도 있지만, 동시에 오염, 기후 변화, 삼림 벌채 등 수많은 다른 문서들도 함께 검색될 것입니다. 주택 건설에 대한 특정 문서가 이 잡음 속에서 순위가 낮아져 묻힐 수 있습니다.

  * **향상 후 (정확도 높은 검색)**:

      * **LLM의 역할**: LLM에게 원본 질문을 여러 각도에서 재구성하여 다양한 버전의 질문을 생성하도록 지시합니다.
      * **생성된 하위 검색어**:
        1.  `도시 개발이 특정 종의 서식지에 미치는 영향`
        2.  `주거 지역 확장이 곤충 개체수에 미치는 결과`
        3.  `멸종 위기 동물의 주된 서식지 파괴 원인`
      * **검색 방식**: 시스템은 세 개의 하위 검색어 각각에 대해 병렬적으로 검색을 실행합니다.
      * **결과 종합**: 모든 검색 결과를 수집합니다. 여러 하위 검색어의 결과 목록에 **공통적으로 나타나는 문서**는 최종 순위에서 더 높은 점수를 받습니다.
      * **결과**: \*\*문서 2 (`...40fe`)\*\*는 생성된 세 개의 검색어 모두와 관련성이 매우 높습니다.  결과적으로 최종 종합 순위에서 상당한 가점을 받아 사용자나 최종 답변 생성 단계에 제시될 확률이 비약적으로 높아집니다. 이 기법은 광범위한 주제를 지식 베이스 내의 매우 구체적이고 관련성 높은 예시로 성공적으로 좁혀줍니다.

-----

### **쿼리 향상 기법 적용 종합 테이블**

| 사용자 원본 질문 | 문제 유형 | 적용 기법 | 향상된 검색어 / 프로세스 | 목표 문서 |
| :--- | :--- | :--- | :--- | :--- |
| "그럼 구체적으로 어떻게 해야 하는데?" | 다중 대화 | **질의 재작성** | `건강한 체중 감량을 위해 에너지 균형을 맞추는 구체적인 식단과 운동 방법은 무엇인가?` | `...ee66` (에너지 균형) |
| "주택 건설이 나비 숙주 식물에 미치는 영향?" | 너무 구체적 | **스텝백 프롬프트** | `인간의 도시 개발이 특정 나비 종의 멸종 위기에 미치는 요인은 무엇인가?` | `...40fe` (마이애미파랑나비) |
| "에너지 균형이란 무엇이고, 그걸 유지하기 위한 활동과 기간은 어떻게 돼?" | 복합 질문 | **질의 분해** | 1. `에너지 균형의 정의`\<br\>2. `에너지 균형 유지를 위한 신체 활동`\<br\>3. `에너지 균형을 달성하는 데 필요한 기간` | `...ee66` (에너지 균형) |
| "인간의 욕심이 자연에 미치는 영향" | 개념적/추상적 | **HyDE** | (도시 개발과 서식지 파괴에 대한 *생성된 가상 답변*의 임베딩을 사용하여 검색) | `...40fe` (마이애미파랑나비) |
| "인간 활동이 야생 동물에 미치는 영향은?" | 광범위/일반 | **다중 질의 검색** | 1. `도시 개발이 특정 종의 서식지에 미치는 영향`\<br\>2. `주거 지역 확장이 곤충 개체수에 미치는 결과`\<br\>3. `멸종 위기 동물의 주된 서식지 파괴 원인` | `...40fe` (마이애미파랑나비) |

이 예시들은 LLM 기반의 쿼리 이해 및 향상 계층이 어떻게 사용자의 원본 입력을 정밀하고 효과적인 검색어로 변환하는지를 보여줍니다. 이는 RAG의 '검색(Retrieval)' 부분을 크게 개선하며, 결과적으로 '생성(Generation)' 부분이 훨씬 더 정확하고 관련성 높은 답변을 만들도록 돕습니다.